# 2025년 8월 16일 수정내역

## 🎯 주요 해결 문제
태국 모델 등 일부 3D 모델이 검게 표시되거나 텍스처가 나타나지 않는 문제 해결

---

## 📝 수정 내역

### 1. 기본 조명 시스템 개선
**파일**: `viewer_utils.py`

#### 문제점
- Phong shading이 비활성화된 상태에서 조명이 전혀 없어 모델이 검게 보임
- 초기 로드 시 모든 조명이 비활성화되어 있음

#### 해결방법
```javascript
// 기본 조명 추가 - 항상 활성화
basicLight = new THREE.AmbientLight(0xffffff, 1.0);
scene.add(basicLight);
```

- 기본 AmbientLight를 항상 활성화 상태로 유지
- Phong shading 토글 시 기본 조명 강도 조절
  - Phong ON: basicLight.intensity = 0.3
  - Phong OFF: basicLight.intensity = 1.0

---

### 2. 텍스처 파일 확장자 자동 매칭
**파일**: `viewer_utils.py`

#### 문제점
- MTL 파일: `.png` 확장자로 텍스처 참조
- 실제 파일: `.jpg` 확장자 (이미지 최적화로 인한 자동 변환)
- 확장자 불일치로 텍스처가 로드되지 않음

#### 해결방법
```javascript
// 확장자 무시하고 파일명으로 매칭
const baseFileName = textureFileName.replace(/\.[^/.]+$/, "");
for (let texName in textures) {
    const texBaseName = texName.replace(/\.[^/.]+$/, "");
    if (texBaseName === baseFileName) {
        matchedTexture = textures[texName];
        matchedTextureName = texName;
        console.log('Texture matched with different extension: ' + 
                    textureFileName + ' -> ' + texName);
        break;
    }
}
```

- 정확한 파일명으로 먼저 찾기
- 못 찾으면 확장자 제거 후 파일명만으로 매칭
- PNG ↔ JPG 자동 매칭 지원

---

### 3. MTL Material 처리 방식 개선
**파일**: `viewer_utils.py`

#### 문제점
- 일부 MTL 파일이 PhongMaterial로 로드됨
- Phong shading 토글 시 PhongMaterial → PhongMaterial 중복 적용
- 높은 Ka(Ambient) 값으로 인한 어두운 렌더링

#### 해결방법
```javascript
// 모든 재질 처리 - 항상 BasicMaterial로 강제 변환
for (let materialName in materials.materials) {
    // 텍스처가 있는 경우
    if (matchedTexture) {
        const basicMaterial = new THREE.MeshBasicMaterial({
            map: matchedTexture,
            side: THREE.FrontSide,
            // ... 기타 설정
        });
        materials.materials[materialName] = basicMaterial;
    } else {
        // 텍스처가 없는 경우도 BasicMaterial로 변환
        const basicMaterial = new THREE.MeshBasicMaterial({
            color: material.color || new THREE.Color(0xcccccc),
            // ... 기타 설정
        });
        materials.materials[materialName] = basicMaterial;
    }
}
```

- 모든 MTL material을 BasicMaterial로 강제 변환
- Phong shading은 토글 시에만 적용
- 이미 PhongMaterial인 경우 속성만 조정

---

### 4. PhongMaterial 중복 적용 방지
**파일**: `viewer_utils.py`

#### 추가 로직
```javascript
// 이미 PhongMaterial인 경우는 조명 설정만 조정
if (child.material.type === 'MeshPhongMaterial' || 
    (Array.isArray(child.material) && 
     child.material[0]?.type === 'MeshPhongMaterial')) {
    console.log('Already PhongMaterial, adjusting properties:', 
                child.name || 'unnamed');
    
    // PhongMaterial의 속성 조정
    if (Array.isArray(child.material)) {
        child.material.forEach(mat => {
            if (mat.type === 'MeshPhongMaterial') {
                mat.emissive = new THREE.Color(0x0a0a0a);
                mat.shininess = 0;
                mat.specular = new THREE.Color(0x000000);
            }
        });
    } else {
        child.material.emissive = new THREE.Color(0x0a0a0a);
        child.material.shininess = 0;
        child.material.specular = new THREE.Color(0x000000);
    }
    return;
}
```

---

## 🔍 원인 분석

### 텍스처 최적화로 인한 확장자 변경
**파일**: `texture_optimizer.py`

- PNG 파일 업로드 시 투명도 검사
- 투명도 없음 → JPG로 자동 변환 (용량 최적화)
- 2MB PNG → 200KB JPG (약 90% 용량 절감)

### Sample Data 분석
**경로**: `/data/sample data/`

- OBJ 파일: `mtllib thai_rr.mtl` 참조 (실제: `model.mtl`)
- MTL 파일: `.png` 확장자로 텍스처 참조
- 실제 파일: `.jpg` 확장자
- Material 설정: Ka=0.8, Kd=0.8, Ks=0 (높은 ambient 값)

---

## ✅ 테스트 결과

1. **태국 모델**: 정상 표시 (텍스처 자동 매칭)
2. **함뵤리 모델**: 정상 표시 (기존 동작 유지)
3. **Phong shading ON/OFF**: 모두 정상 동작
4. **다양한 확장자**: PNG, JPG, JPEG 모두 자동 매칭

---

## 📌 개선 효과

- 사용자가 수동으로 MTL 파일을 수정할 필요 없음
- 이미지 최적화 후에도 자동으로 텍스처 매칭
- 모든 모델에서 일관된 렌더링 품질
- Phong shading 토글 시 부드러운 전환

---

## 💡 추가 권장사항

1. MTL 파일 생성 시 텍스처 확장자 확인
2. 업로드 전 3D 프로그램에서 미리 확인
3. 큰 텍스처는 사전 최적화 권장 (2MB 이하)