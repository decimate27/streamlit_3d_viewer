# 초기화 검은색 화면 제거 플랜

## 배경과 증상
- 공유 링크로 뷰어 진입 시 잠깐 검은 화면 → 이어서 흰 화면 → 최종 모델 표시.
- 초기 프레임에서 WebGL 캔버스 기본 클리어(검정)와 로딩 오버레이(흰색) 간 색상 불일치 가능성이 높음.

## 근본 원인 가설
- WebGLRenderer 초기 버퍼가 검정(기본값)으로 한 프레임 노출.
- `preserveDrawingBuffer: true`로 초기 상태가 그대로 보여짐.
- 캔버스가 첫 유효 렌더 전 노출되고, 로딩 오버레이 배경색(흰색)과 페이지 배경/렌더러 색이 불일치.

## 개선 전략(요약)
- 캔버스 투명화 + 페이지 배경 사용: `alpha: true`, `setClearAlpha(0)`.
- 캔버스 최초 렌더까지 숨김: 최초 유효 프레임 이후 페이드인(모바일 한정 → 전 플랫폼 확대).
- 로딩 오버레이 배경을 선택된 배경색과 동일하게 설정.
- 초기 프레임 강제 렌더(프라임 렌더)로 버퍼 색상 확정.
- 성능/초기 플래시 감소를 위해 `preserveDrawingBuffer: false`로 복귀.

## 단계별 실행 계획
1) Renderer 옵션 조정
- `alpha: true`, `premultipliedAlpha: false`, `preserveDrawingBuffer: false`로 생성.
- `renderer.setClearColor(0x{bg}, 0)` 또는 `renderer.setClearAlpha(0)` 적용.

2) CSS/DOM 조정
- `canvas { background: transparent !important; }` 추가.
- 캔버스 초기 `visibility: hidden`(또는 `opacity: 0`) 설정, 첫 유효 렌더 후 `visible`로 전환(모바일 한정 로직을 전 플랫폼으로 확장).

3) 로딩 오버레이 색상 일치
- `#loadingOverlay { background: {bg_color}; }`로 배경색 동기화.
- 이미 있는 `updateLoadingOverlayStyle()`에서 다크/라이트 분기 대신 정확히 지정 배경색 사용.

4) 초기 프레임 프라임 렌더
- renderer append 직후: `renderer.clear(true,true,true); renderer.render(scene,camera); requestAnimationFrame(()=>renderer.render(scene,camera));` 호출.

5) 배경색 변경 경로 통일
- 배경 변경 함수에서 body/canvas 스타일, `scene.background`, `renderer.setClearColor`를 모두 동시에 갱신.

## 코드 변경 포인트(예시)
- 파일: `viewer_utils.py`
- Renderer 생성부:
```js
renderer = new THREE.WebGLRenderer({
  antialias: true,
  powerPreference: 'high-performance',
  alpha: true,
  premultipliedAlpha: false,
  preserveDrawingBuffer: false,
  depth: true,
  precision: 'highp'
});
renderer.setClearColor(0xFFFFFF, 0); // 또는 bg 동적 값
renderer.setClearAlpha(0);
renderer.domElement.style.visibility = 'hidden'; // 최초 숨김(모바일 한정 제거)
```
- CSS:
```css
canvas { background: transparent !important; }
#loadingOverlay { background: /* {bg_color} */; }
```
- 초기화 직후 프라임 렌더:
```js
container.appendChild(renderer.domElement);
renderer.clear(true,true,true);
renderer.render(scene, camera);
requestAnimationFrame(()=>renderer.render(scene, camera));
```
- 모델 로드 완료 시 페이드인:
```js
renderer.domElement.style.visibility = 'visible';
renderer.domElement.style.opacity = '1';
```

## 검증 체크리스트
- 모든 배경 모드(흰/회/검)에서 초기 플래시가 사라지는지.
- iOS/Android, 데스크톱 크롬/사파리/엣지에서 동일 동작.
- 모델 미로딩 상태에서 오버레이 배경과 최종 배경이 일치.
- 성능 회귀(프레임 저하) 없는지(`preserveDrawingBuffer: false`).

## 리스크 및 롤백
- 알파 사용 시 일부 브라우저에서 색 관리 차이 → 필요 시 `alpha:false` 유지 + 초기 가리기 전략만 적용.
- 문제가 생기면: (1) 알파 해제 (2) 캔버스 가리기만 유지 (3) 오버레이 배경만 동기화 적용으로 단계적 롤백.
